window.requestAnimFrame=(function(){return function(a){window.setTimeout(a,1000/60)}})();Function.prototype.inheritsFrom=function(a){this.prototype=new a();this.prototype.parent=a;this.prototype.constructor=this};Function.prototype.defineSingleton=function(){this._instance=null;this.args=arguments;function a(){if(this._instance==null){this._instance=new this()}return this._instance}Object.defineProperty(this,"instance",{get:a,set:function(){console.log("Trying to set a singleton instance. Fuck you.")}})};Array.prototype.each=function(b,c){for(var a=0;a<this.length;a++){b.call(c,this[a],a,this)}return this};Array.prototype.flatten=function(){var c=[];for(var a=0;a<this.length;a++){var b=typeof(this[a]);if(b=="null"){continue}c=c.concat((b=="array"||b=="collection"||b=="arguments"||(this[a] instanceof Array))?Array.flatten(this[a]):this[a])}return c};Array.prototype.contains=function(a){return this.indexOf(a)!=-1};Object.each=function(c,b){for(var a in c){b.call(c,c[a],a)}return c};function getEventKey(){var a=new Array(50);a[16]="shift";a[18]="alt";a[20]="maj";a[27]="esc";a[32]="space";a[37]="left";a[38]="up";a[39]="right";a[40]="down";this._key=a[this.keyCode];return this._key}KeyboardEvent.prototype._key=-1;Object.defineProperty(KeyboardEvent.prototype,"key",{get:getEventKey,set:function(){console.log("Trying to set key of an event. Fuck you.")}});document.id=document.getElementById;Anchors={TOPLEFT:0,TOPCENTER:1,TOPRIGHT:2,CENTERLEFT:3,CENTER:4,CENTERRIGHT:5,BOTTOMLEFT:6,BOTTOMCENTER:7,BOTTOMRIGHT:8};var CPDisplayObject=function(c){this.x=this.y=0;this.width=this.height=0;this.flipX=this.flipY=false;this._anchor=Anchors.TOPLEFT;this._anchorOffsetX=this._anchorOffsetY=0;function a(d){this._anchor=d;if((this._anchor==Anchors.CENTER)||(this._anchor==Anchors.TOPCENTER)||(this._anchor==Anchors.BOTTOMCENTER)){this._anchorOffsetX=-this.width/2}if((this._anchor==Anchors.CENTERRIGHT)||(this._anchor==Anchors.TOPRIGHT)||(this._anchor==Anchors.BOTTOMRIGHT)){this._anchorOffsetX=-this.width}if((this._anchor==Anchors.CENTERLEFT)||(this._anchor==Anchors.CENTER)||(this._anchor==Anchors.CENTERRIGHT)){this._anchorOffsetY=-this.height/2}if((this._anchor==Anchors.BOTTOMLEFT)||(this._anchor==Anchors.BOTTOMCENTER)||(this._anchor==Anchors.BOTTOMRIGHT)){this._anchorOffsetY=-this.height}}Object.defineProperty(this,"anchor",{get:function(){return this._anchor},set:a.bind(this)});this.canvas=null;this.context=null;this._scale=1;this.alpha=1;function b(d){this.width*=1/this._scale;this.height*=1/this._scale;this._scale=d;this.width*=this._scale;this.height*=this._scale}Object.defineProperty(this,"scale",{get:function(){return this._scale},set:b});if(c){if(c.name){this.name=c.name}if(c.x){this.x=c.x}if(c.y){this.y=c.y}if(c.width){this.width=c.width}if(c.height){this.height=c.height}if(typeof(c.anchor)!="undefined"){this.anchor=c.anchor}if(c.scale){this.scale=c.scale}}};CPDisplayObject.prototype.destroy=function(){for(var a in this){this[a]=null}};CPDisplayObject.prototype.needsRedraw=function(){CPSceneManager.instance.invalidate(this.context)};CPDisplayObject.prototype.prepareDraw=function(){var b=this.x+this._anchorOffsetX;var a=this.y+this._anchorOffsetY;this.context.globalAlpha=this.alpha;if(this.flipX){this.context.scale(-1,1);b=(b*(-1))-this.width}if(this.flipY){this.context.scale(1,-1);a=(a*(-1))-this.height}return{x:b,y:a}};CPDisplayObject.prototype.draw=function(){};var CPImage=function(a){if(a){this.parent.call(this,a);if(a.img){this.img=a.img}else{console.log("invalid img")}this.width=this.img.width;this.height=this.img.height;if(a.width){this.width=a.width}if(a.height){this.height=a.height}}};CPImage.inheritsFrom(CPDisplayObject);CPImage.prototype.draw=function(){this.context.save();var a=CPDisplayObject.prototype.prepareDraw.call(this);this.context.drawImage(this.img,a.x*this.scale,a.y*this.scale,this.width*this.scale,this.height*this.scale);this.context.restore()};var CPSprite=function(a){if(a){CPDisplayObject.call(this,a)}this.sequences={};this.currentSequence=null;this.nextTick=1;this.timeBeforeTick=0;this.paused=true;this.isLocked=false;this.firstDraw=false};CPSprite.inheritsFrom(CPDisplayObject);CPSprite.prototype.add=function(b){var a={};a.offset=0;a.totalFrame=0;a.nextTick=1000;a.frameSize={w:0,h:0};a.scale=1;if(b.sequenceName){a.sequenceName=b.sequenceName}else{console.log("No name for the sequence : "+b);return}if(b.spriteSheet){a.img=b.spriteSheet;a.sheetSize={w:a.img.width,h:a.img.height}}else{console.log("invalid spriteSheet for "+a.name);return}if(b.totalFrame){a.totalFrame=b.totalFrame}if(b.offset){a.offset=b.offset}if(b.framePerSecond){a.nextTick=1/b.framePerSecond}a.timeBeforeTick=a.nextTick;if(b.scale){a.scale=b.scale}if(b.frameSize){a.frameSize=b.frameSize}a.currentFrame=a.offset+1;a.framePerRow=Math.floor(a.sheetSize.w/a.frameSize.w);this.width=a.frameSize.w;this.height=a.frameSize.h;this.sequences[b.sequenceName]=a};CPSprite.prototype.currentFramePlusPlus=function(){if(!this.paused){if(this.currentSequence.currentFrame+1>this.currentSequence.totalFrame+this.currentSequence.offset){if(this.currentSequence.oneShot){this.pause();return}this.currentSequence.currentFrame=this.currentSequence.offset+1}else{this.currentSequence.currentFrame+=1}}};CPSprite.prototype.start=function(b,a){if(!this.locked()){this.paused=false;if(this.currentSequence==this.sequences[b]){return}this.currentSequence=this.sequences[b];this.width=this.currentSequence.frameSize.w;this.height=this.currentSequence.frameSize.h;this.scale=this.currentSequence.scale;if(a&&a.oneShot){this.currentSequence.oneShot=a.oneShot}if(a&&a.startFrame&&a.startFrame>0&&a.startFrame<=thisCurrentSequence.totalFrame){this.currentSequence.currentFrame=a.startFrame}else{this.currentSequence.currentFrame=this.currentSequence.offset+1}this.currentSequence.timeBeforeTick=this.currentSequence.nextTick;this.firstDraw=true}};CPSprite.prototype.locked=function(){return this.isLocked};CPSprite.prototype.lock=function(){this.isLocked=true};CPSprite.prototype.unlock=function(){this.isLocked=false};CPSprite.prototype.pause=function(){this.paused=true;console.log("pause")};CPSprite.prototype.resume=function(){this.paused=false;console.log("resume")};CPSprite.prototype.gotoAndStop=function(a){if(this.currentSequence.totalFrame>=a&&a>0){this.currentSequence.currentFrame=a}this.pause();this.draw()};CPSprite.prototype.update=function(a){if(this.firstDraw){this.firstDraw=false;return this.context}if(this.paused||this.isLocked){return false}this.currentSequence.timeBeforeTick=this.currentSequence.timeBeforeTick-a;if(this.currentSequence.timeBeforeTick<=0){this.currentFramePlusPlus();this.currentSequence.timeBeforeTick+=this.currentSequence.nextTick;return this.context}return false};CPSprite.prototype.draw=function(){this.context.save();var b=CPDisplayObject.prototype.prepareDraw.call(this);if(this.paused||this.isLocked){return}var a=[((this.currentSequence.currentFrame-1)%this.currentSequence.framePerRow)*this.currentSequence.frameSize.w,(Math.floor((this.currentSequence.currentFrame-1)/this.currentSequence.framePerRow))*this.currentSequence.frameSize.h,this.currentSequence.frameSize.w,this.currentSequence.frameSize.h];this.context.drawImage(this.currentSequence.img,a[0],a[1],a[2],a[3],b.x,b.y,this.width,this.height);this.context.restore()};var CPText=function(c){this._content="no content";this.textAlign="left";this.textBaseline="top";this.font="20pt Courier";this.color="rgb(0, 0, 0)";function a(d){this._content=d;if(this.context){this.context.font=this.font;this.width=this.context.measureText(this._content).width;this.height=this.context.measureText("eee").width;this.anchor=this.anchor;this.needsRedraw()}}Object.defineProperty(this,"content",{get:function(){return this._content},set:a});function b(d){this._canvas=d;if(this._canvas){this.context=this._canvas.getContext("2d");this.context.font=this.font;this.width=this.context.measureText(this._content).width;this.height=this.context.measureText("eee").width;this.anchor=this.anchor}}Object.defineProperty(this,"canvas",{get:function(){return this._canvas},set:b});if(c){CPDisplayObject.call(this,c);if(c.content){this.content=c.content}if(c.textAlign){this.textAlign=c.textAlign}if(c.textBaseline){this.textBaseline=c.textBaseline}if(c.font){this.font=c.font}if(c.color){this.color=c.color}if(c.backgroundColor){this.backgroundColor=c.backgroundColor}}};CPText.inheritsFrom(CPDisplayObject);CPText.prototype.draw=function(){this.context.save();var a=CPDisplayObject.prototype.prepareDraw.call(this);if(this.backgroundColor){this.context.beginPath();this.context.rect(a.x,a.y,this.width,this.height);this.context.fillStyle=this.backgroundColor;this.context.fill()}this.context.textAlign=this.textAlign;this.context.textBaseline=this.textBaseline;this.context.font=this.font;this.context.fillStyle=this.color;this.context.fillText(this.content,a.x,a.y);this.context.restore()};var CPDisplayGroup=function(){this.scale=1;this.canvasToUpdate=[];this.displayObjects={};this._x=this._y=0;this._width=this._height=0;this._boxMinX=this._boxMinY=null;this._boxMaxX=this._boxMaxY=null;function b(d){var c=d-this._x;Object.each(this.displayObjects,function(e){e.x+=c;this.canvasToUpdate.push(e.context)}.bind(this));this._x=d}Object.defineProperty(this,"x",{get:function(){return this._x},set:b});function a(d){var c=d-this._y;Object.each(this.displayObjects,function(e){e.y+=c;this.canvasToUpdate.push(e.context)}.bind(this));this._y=d}Object.defineProperty(this,"y",{get:function(){return this._y},set:a})};CPDisplayGroup.prototype.destroy=function(){Object.each(this.displayObjects,function(b){b.destroy();b=null});for(var a in this){this[a]=null}};CPDisplayGroup.prototype.insert=function(b,a){this.displayObjects[b]=a;if(a.width>this._width){this._width=a.width}if(a.height>this._height){this._height=a.height}var d=a.x+a._anchorOffsetX;var c=a.y+a._anchorOffsetY;var f=d+a.width;var e=c+a.height;if((this._boxMinX==null)||(this._boxMinX>d)){this._boxMinX=d}if((this._boxMinY==null)||(this._boxMinY>c)){this._boxMinY=c}if((this._boxMaxX==null)||(this._boxMaxX<f)){this._boxMaxX=f}if((this._boxMaxY==null)||(this._boxMaxY<e)){this._boxMaxY=e}if(a.needsRedraw&&a.context){a.needsRedraw()}};CPDisplayGroup.prototype.remove=function(a){this.displayObjects[a].needsRedraw();this.displayObjects[a]=null;delete this.displayObjects[a]};CPDisplayGroup.prototype.update=function(b){var a=this.canvasToUpdate;Object.each(this.displayObjects,function(d){if(d.update){var c=d.update(b);if(c){if(d instanceof CPDisplayGroup){c.each(function(e){a.push(e)})}else{a.push(c)}}}}.bind(this));this.canvasToUpdate=[];return a};CPDisplayGroup.prototype.onPause=function(){Object.each(this.displayObjects,function(a){if(a.onPause){a.onPause()}if(a.pause){a.pause()}}.bind(this))};CPDisplayGroup.prototype.onResume=function(){Object.each(this.displayObjects,function(a){if(a.onResume){a.onResume()}if(a.resume){a.resume()}}.bind(this))};CPDisplayGroup.prototype.render=function(b){var a=[];Object.each(this.displayObjects,function(c){if(c instanceof CPDisplayGroup){a.push(c.render(b))}else{if(b.contains(c.context)){a.push(c)}}});a.each(function(c){if(c!=null){c.draw()}},this)};CPDisplayGroup.prototype.get=function(a){return this.displayObjects[a]};var CPButton=function(a){this.text=null;this.buttonNormal=null;this.buttonOver=null;this.buttonTouched=null;this.over=false;this.touched=false;this._onClick=null;this._textWidth=0;if(a){this.parent.call(this,a);if(a.buttonNormal){this.buttonNormal=a.buttonNormal}if(a.buttonOver){this.buttonOver=a.buttonOver}if(a.buttonTouched){this.buttonTouched=a.buttonTouched}if(a.text){this.text=a.text}if(a.font){this.font=a.font}if(a.bgColor){this.bgColor=a.bgColor}if(a.strokeColor){this.strokeColor=a.strokeColor}if(a.bgColorOver){this.bgColorOver=a.bgColorOver}if(a.strokeColorOver){this.strokeColorOver=a.strokeColorOver}if(a.strokeWidth){this.strokeWidth=a.strokeWidth}if(a.bgColorTouched){this.bgColorTouched=a.bgColorTouched}if(a.strokeColorTouched){this.strokeColorTouched=a.strokeColorTouched}if(a.onClick){this._onClick=a.onClick}}CPButton.actionCanvas.addListener(this);this.over=false;this.touched=false};CPButton.inheritsFrom(CPDisplayObject);CPButton.prototype.onOver=function(){if(!this.over){this.needsRedraw();this.over=true}};CPButton.prototype.onLeave=function(){this.needsRedraw();this.touched=false;this.over=false};CPButton.prototype.onTouch=function(){if(!this.touched){this.needsRedraw();this.touched=true}};CPButton.prototype.onClick=function(){this.needsRedraw();this.touched=false;if(this._onClick){this._onClick()}};CPButton.prototype.draw=function(){this.context.save();var b=CPDisplayObject.prototype.prepareDraw.call(this);var a=(this.touched?this.buttonTouched:(this.over?this.buttonOver:this.buttonNormal));this.context.drawImage(a,b.x*this.scale,b.y*this.scale,this.width*this.scale,this.height*this.scale);if(this.text==null){return}this.context.font=this.font;this._textWidth=this.context.measureText("ee").width;this.context.textAlign="center";this.context.textBaseline="top";this.context.fillStyle="black";this.context.fillText(this.text,this.x+this.width/2,this.y+this.height/2+(this.touched?1:0)-this._textWidth/2);this.context.restore()};CPButton.actionCanvas=null;var CPActionCanvas=function(b,a){this.canvas=document.createElement("canvas");document.id("game_div").appendChild(this.canvas);var c=this.canvas.getBoundingClientRect();this.originX=Math.round(c.left);this.originY=Math.round(c.top);this.mouseX=-1;this.mouseY=-1;this.listeners=[];this.active=true;this.canvas.id="cpactioncanvas";this.canvas.style.position="absolute";this.canvas.style.zIndex=1000;this.canvas.addEventListener("mousemove",this.mouseMove.bind(this));this.canvas.addEventListener("mouseenter",this.mouseEnter.bind(this));this.canvas.addEventListener("mouseleave",this.mouseLeave.bind(this));this.canvas.addEventListener("mousedown",this.mouseDown.bind(this));this.canvas.addEventListener("mouseup",this.mouseUp.bind(this))};CPActionCanvas.prototype.addListener=function(a){this.listeners.push(a)};CPActionCanvas.prototype.removeListener=function(a){};CPActionCanvas.prototype.setMousePos=function(a){this.mouseX=a.pageX-this.originX;this.mouseY=a.pageY-this.originY};CPActionCanvas.prototype.mouseMove=function(a){if(!this.active){return}this.setMousePos(a);this.listeners.each(function(b){if((b.x+b._anchorOffsetX<this.mouseX&&this.mouseX<(b.x+b._anchorOffsetX+b.width))&&(b.y+b._anchorOffsetY<this.mouseY&&this.mouseY<(b.y+b._anchorOffsetY+b.height))){b.overed=true;if(b.onOver){b.onOver()}}else{if(b.over){b.overed=false;if(b.onLeave){b.onLeave()}}}}.bind(this))};CPActionCanvas.prototype.mouseEnter=function(a){if(!this.active){return}};CPActionCanvas.prototype.mouseLeave=function(a){if(!this.active){return}this.mouseX=-1;this.mouseY=-1};CPActionCanvas.prototype.mouseClick=function(a){if(!this.active){return}if(this.mouseX==-1||this.mouseY==-1){console.error("We shouldn't be here...")}};CPActionCanvas.prototype.mouseDown=function(a){if(!this.active){return}if(this.mouseX==-1||this.mouseY==-1){console.error("We shouldn't be here...")}this.listeners.each(function(b){if(b.overed){if(b.onTouch){b.onTouch()}}}.bind(this))};CPActionCanvas.prototype.mouseUp=function(a){if(!this.active){return}if(this.mouseX==-1||this.mouseY==-1){console.error("We shouldn't be here...")}this.listeners.each(function(b){if(b.touched){if(b.onClick){b.onClick()}}})};var CPSceneManager=function(){var c=CPGame.instance;this.currentScene=null;this.allCanvas=[];this.allContexts=[];this.allCanvasToRedraw=[];this.timeLastFrame=0;this.invalidated=false;this.paused=false;this.actionCanvas=new CPActionCanvas(c.canvasWidth,c.canvasHeight);this.actionCanvas.canvas.width=c.canvasWidth;this.actionCanvas.canvas.height=c.canvasHeight;CPButton.actionCanvas=this.actionCanvas;document.addEventListener("keydown",function(d){if(this.currentScene.keyDown){if(!this.currentScene.keyDown(d)){d.preventDefault()}}}.bind(this));document.addEventListener("keyup",function(d){if(this.currentScene.keyUp){if(!this.currentScene.keyUp(d)){d.preventDefault()}}}.bind(this));b=function b(){this.resumeScene()}.bind(this);a=function a(){this.pauseScene()}.bind(this);if(document.all){window.onfocusin=b;window.onfocusout=a}else{window.onfocus=b;window.onblur=a}this.update()};CPSceneManager.defineSingleton();CPSceneManager.prototype.setScene=function(sceneName,blendMode){if(this.currentScene){this.currentScene.destroy()}this.currentScene=null;this.currentScene=eval("new "+sceneName+"()");this.currentScene.sceneManager=this;this.allContexts.each(function(ctx){this.invalidate(ctx)},this)};CPSceneManager.prototype.invalidate=function(a){this.invalidated=true;this.allCanvasToRedraw.push(a)};CPSceneManager.prototype.update=function(){window.requestAnimFrame(function(b){if(this.paused){return}if(!b){b=new Date().getTime()}var a=(this.timeLastFrame==0)?0:0.001*(b-this.timeLastFrame);this.timeLastFrame=b;CPGame.instance.fps=1/a;if(a>1/20){console.error("HEY !")}if(this.currentScene){if(this.currentScene.update){this.currentScene.update(a)}else{console.error("The currentScene does not have an update() function !")}}if(this.invalidated){this.render();this.invalidated=false;this.allCanvasToRedraw=[]}this.update()}.bind(this))};CPSceneManager.prototype.pauseScene=function(){this.paused=true;this.currentScene.onPause()};CPSceneManager.prototype.resumeScene=function(){this.paused=false;this.currentScene.onResume();this.timeLastFrame=0;this.update()};CPSceneManager.prototype.render=function(){this.allCanvasToRedraw.each(function(a){a.clearRect(0,0,CPGame.instance.canvasWidth,CPGame.instance.canvasHeight)},this);this.currentScene.render(this.allCanvasToRedraw)};CPSceneManager._sceneManager=null;var CPResourceManager=function(c,b,a){this.loader=new PxLoader();this.images={};this.sounds={}};CPResourceManager.prototype.init=function(c,b,a){if(c){c.each(function(d){this.images[d.imageName]=new PxLoaderImage(d.imagePath);this.loader.add(this.images[d.imageName])}.bind(this))}this.loader.addProgressListener(function(f){var d=f.completedCount/f.totalCount*100;if(a){a(d)}});this.loader.addCompletionListener(function(){if(b){b(this)}}.bind(this));this.loader.start()};CPResourceManager.defineSingleton();CPResourceManager.prototype.startLoading=function(){this.loader.start()};CPResourceManager.prototype.getImage=function(a){return this.images[a].img};CPResourceManager.prototype.getSound=function(a){return this.sounds[a]};var CPLayer=function(b,a){this.canvas=document.createElement("canvas");this.canvas.style.position="absolute";this.canvas.style.zIndex=b;this.canvas.width=CPGame.instance.canvasWidth;this.canvas.height=CPGame.instance.canvasHeight;document.id(a||"game_div").appendChild(this.canvas);this.context=this.canvas.getContext("2d");this.displayGroup=new CPDisplayGroup()};CPLayer.prototype.destroy=function(){this.displayGroup.destroy();this.displayGroup=null;this.canvas.parentNode.removeChild(this.canvas);this.canvas=null;for(var a in this){this[a]=null}};CPLayer.prototype.insert=function(b,a){a.canvas=this.canvas;a.context=a.canvas.getContext("2d");this.displayGroup.insert(b,a)};CPLayer.prototype.remove=function(a){this.displayGroup.remove(a)};CPLayer.prototype.update=function(b){if(this.displayGroup){var a=this.displayGroup.update(b);a=a.flatten();a.each(function(c){CPSceneManager.instance.invalidate(c)},this)}};CPLayer.prototype.onPause=function(){this.displayGroup.onPause()};CPLayer.prototype.onResume=function(){this.displayGroup.onResume()};CPLayer.prototype.render=function(a){this.displayGroup.render(a)};var CPScene=function(){this.layers=[]};CPScene.prototype.update=function(a){this.layers.each(function(b){b.update(a)})};CPScene.prototype.destroy=function(){if(this.free){this.free()}while(this.layers.length){this.layers[0].destroy();this.layers[0]=null;this.layers.shift()}this.layers=[]},CPScene.prototype.addLayer=function(b){var a=new CPLayer(b);this.layers.push(a);return a},CPScene.prototype.onPause=function(){this.layers.each(function(a){a.onPause()})},CPScene.prototype.onResume=function(){this.layers.each(function(a){a.onResume()})};CPScene.prototype.needsRedraw=function(a){CPSceneManager.instance.invalidate(a)};CPScene.prototype.render=function(a){this.layers.each(function(b){b.render(a)})};